<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ateur de Pixel Art (Vrais Pixels)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-cyan-400">Cr√©ateur de VRAI Pixel Art</h1>
            <p class="text-gray-400 mt-2">Chargez une image pour une conversion parfaite, sans flou.</p>
        </header>

        <main class="bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-8">
            <!-- Zone des contr√¥les -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6 p-4 rounded-xl border border-gray-700 bg-gray-800/50">
                <!-- Contr√¥le de Fichier -->
                <div class="flex flex-col items-center justify-center">
                    <label for="imageLoader" class="w-full text-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg cursor-pointer transition-all duration-300 shadow-md">
                        üñºÔ∏è Choisir une image
                    </label>
                    <input type="file" id="imageLoader" name="imageLoader" class="hidden"/>
                    <span id="fileName" class="text-xs text-gray-400 mt-2 text-center truncate w-full px-2">Aucun fichier choisi</span>
                </div>

                <!-- Curseur de Pixelisation -->
                <div class="flex flex-col items-center justify-center">
                    <label for="pixelSize" class="block text-sm font-medium text-gray-300 mb-2">Taille des pixels: <span id="pixelValue" class="font-bold text-cyan-400">12</span></label>
                    <input id="pixelSize" type="range" min="2" max="50" value="12" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>
                
                <!-- S√©lecteur de Palette -->
                <div class="flex flex-col items-center justify-center">
                    <label for="paletteSelector" class="block text-sm font-medium text-gray-300 mb-2">Palette de couleurs</label>
                    <select id="paletteSelector" class="w-full bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 p-2.5">
                        <option value="none">Couleurs Originales</option>
                        <option value="pico8">PICO-8</option>
                        <option value="gameboy">Game Boy</option>
                        <option value="grayscale">Niveaux de gris</option>
                        <option value="sepia">S√©pia</option>
                        <option value="cga">Ancien PC (CGA)</option>
                    </select>
                </div>

                <!-- Bouton de T√©l√©chargement -->
                <div class="flex flex-col items-center justify-center">
                     <button id="downloadButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 shadow-md disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                        üíæ T√©l√©charger
                    </button>
                </div>
            </div>

            <!-- Zone d'affichage de l'image -->
            <div class="w-full bg-dots-pattern rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center" style="min-height: 50vh; background-image: radial-gradient(circle, #4a5568 1px, transparent 1px); background-size: 1rem 1rem;">
                <canvas id="canvas" class="max-w-full max-h-full rounded-md shadow-lg hidden"></canvas>
                <p id="placeholderText" class="text-gray-500">Votre image appara√Ætra ici</p>
            </div>
        </main>
    </div>

    <script>
        // --- R√©f√©rences aux √©l√©ments du DOM ---
        const imageLoader = document.getElementById('imageLoader');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pixelSizeSlider = document.getElementById('pixelSize');
        const pixelValueSpan = document.getElementById('pixelValue');
        const paletteSelector = document.getElementById('paletteSelector');
        const downloadButton = document.getElementById('downloadButton');
        const placeholderText = document.getElementById('placeholderText');
        const fileNameSpan = document.getElementById('fileName');

        let originalImage = null;

        // --- Palettes de couleurs pr√©d√©finies ---
        const palettes = {
            grayscale: ['#000000', '#333333', '#666666', '#999999', '#CCCCCC', '#FFFFFF'],
            sepia: ['#705746', '#3A2A1F', '#A38B7A', '#D4C3B6', '#EFE5DD'],
            gameboy: ['#0f380f', '#306230', '#8bac0f', '#9bbc0f'],
            cga: ['#000000', '#55FFFF', '#FF55FF', '#FFFFFF'],
            pico8: ['#000000', '#1D2B53', '#7E2553', '#008751', '#AB5236', '#5F574F', '#C2C3C7', '#FFF1E8', '#FF004D', '#FFA300', '#FFEC27', '#00E436', '#29ADFF', '#83769C', '#FF77A8', '#FFCCAA']
        };
        
        const palettesRgb = {};
        for (const key in palettes) {
            palettesRgb[key] = palettes[key].map(hexToRgb);
        }

        // --- Fonctions utilitaires pour les couleurs ---
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [0,0,0];
        }

        function colorDistance(rgb1, rgb2) {
            return (rgb1[0] - rgb2[0]) ** 2 + (rgb1[1] - rgb2[1]) ** 2 + (rgb1[2] - rgb2[2]) ** 2;
        }

        function findClosestColor(pixelRgb, paletteRgb) {
            let closestColor = paletteRgb[0];
            let minDistance = colorDistance(pixelRgb, closestColor);
            for (let i = 1; i < paletteRgb.length; i++) {
                let distance = colorDistance(pixelRgb, paletteRgb[i]);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestColor = paletteRgb[i];
                }
            }
            return closestColor;
        }

        // --- NOUVELLE LOGIQUE DE DESSIN MANUEL ---
        function drawPixelated() {
            if (!originalImage) return;

            const pixelSize = parseInt(pixelSizeSlider.value, 10);
            const selectedPaletteKey = paletteSelector.value;
            
            // 1. Calculer les dimensions de la petite image
            const smallWidth = Math.max(1, Math.floor(originalImage.width / pixelSize));
            const smallHeight = Math.max(1, Math.floor(originalImage.height / pixelSize));

            // 2. Dessiner l'image en petit sur un canvas temporaire pour √©chantillonner les couleurs
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = smallWidth;
            tempCanvas.height = smallHeight;
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCtx.drawImage(originalImage, 0, 0, smallWidth, smallHeight);
            
            // 3. (Optionnel) Appliquer la palette de couleurs sur la petite image
            if (selectedPaletteKey !== 'none') {
                const paletteRgb = palettesRgb[selectedPaletteKey];
                const imageData = tempCtx.getImageData(0, 0, smallWidth, smallHeight);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const pixelRgb = [data[i], data[i + 1], data[i + 2]];
                    const closestColor = findClosestColor(pixelRgb, paletteRgb);
                    data[i] = closestColor[0];
                    data[i + 1] = closestColor[1];
                    data[i + 2] = closestColor[2];
                }
                tempCtx.putImageData(imageData, 0, 0);
            }

            // 4. Redimensionner le canvas principal pour qu'il corresponde √† la grille de pixels
            canvas.width = smallWidth * pixelSize;
            canvas.height = smallHeight * pixelSize;
            
            // 5. Dessiner manuellement chaque "gros" pixel en utilisant des rectangles
            // C'est la cl√© pour √©viter le flou du navigateur.
            const smallImageData = tempCtx.getImageData(0, 0, smallWidth, smallHeight).data;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Nettoyer le canvas

            for (let y = 0; y < smallHeight; y++) {
                for (let x = 0; x < smallWidth; x++) {
                    const index = (y * smallWidth + x) * 4;
                    const r = smallImageData[index];
                    const g = smallImageData[index + 1];
                    const b = smallImageData[index + 2];
                    
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                }
            }
        }

        // --- √âcouteurs d'√©v√©nements ---
        const redraw = () => {
            if (originalImage) {
                requestAnimationFrame(drawPixelated);
            }
        };

        imageLoader.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    placeholderText.style.display = 'none';
                    canvas.style.display = 'block';
                    downloadButton.disabled = false;
                    redraw();
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
            fileNameSpan.textContent = file.name;
        });

        pixelSizeSlider.addEventListener('input', (e) => {
            pixelValueSpan.textContent = e.target.value;
            redraw();
        });
        
        paletteSelector.addEventListener('change', redraw);

        downloadButton.addEventListener('click', () => {
            if (originalImage) {
                const link = document.createElement('a');
                link.download = 'pixel-art.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        });
    </script>
</body>
</html>
